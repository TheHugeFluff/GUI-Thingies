-- Polished + Settings/Config Fixes + Backup

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Debris = game:GetService("Debris")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Helpers
local function safeEncode(t)
	local ok, s = pcall(HttpService.JSONEncode, HttpService, t)
	return ok and s or nil
end
local function safeDecode(s)
	local ok, t = pcall(HttpService.JSONDecode, HttpService, s)
	return ok and t or nil
end
local function hasFileIO()
	return type(writefile) == "function" and type(readfile) == "function"
end
local function clamp(n, a, b) return math.max(a, math.min(b, n)) end
local function warnf(...) warn("[FoxParty]", ...) end

-- Config
local GUI_NAME = "Fox Party <3"
local CONFIG_FILENAME = "FoxParty_Config.json"
local BACKUP_FILENAME = CONFIG_FILENAME .. ".bak"

local DEFAULT = {
	windowSize = {600, 420}, -- moderately larger
	bgColor = {28, 28, 28},
	topBarColor = {36, 36, 36},
	buttonColor = {255, 120, 50},
	accentColor = {255, 105, 105},
	textColor = {240, 240, 240},
	font = "GothamBold",
	fontSize = 16,
	transparency = 0.06,
	hearts_per_interval = 3,
	heart_interval = 2.5,
	show_toasts = true,
	enableScript = "-- Enable script here\nprint('Enabled')\n",
	disableScript = "-- Disable script here\nprint('Disabled')\n",
	funnyScript = "-- Funny Time script here\nprint('Funny time!')\n",
	title_text = "ðŸ¦Š Fox Party <3",
	tab_left = "Foxies ^-^",
	tab_right = "Settings",
	saveMode = "file_or_memory"
}

-- Attribute / file persistence helpers
local function setAttr(key, val)
	if type(val) == "table" then
		player:SetAttribute(key, safeEncode(val))
	else
		player:SetAttribute(key, tostring(val))
	end
end
local function getAttr(key)
	local v = player:GetAttribute(key)
	if not v then return nil end
	if type(v) == "string" then
		local dec = safeDecode(v)
		if dec then return dec end
		return v
	end
	return v
end
local function writeConfigFile(tbl)
	if not hasFileIO() then return false, "no_fileio" end
	local enc = safeEncode(tbl)
	if not enc then return false, "encode_failed" end
	local ok, err = pcall(function() writefile(CONFIG_FILENAME, enc) end)
	return ok, err
end
local function writeBackupFile(tbl)
	if not hasFileIO() then return false, "no_fileio" end
	local enc = safeEncode(tbl)
	if not enc then return false, "encode_failed" end
	local ok, err = pcall(function() writefile(BACKUP_FILENAME, enc) end)
	return ok, err
end
local function readConfigFile()
	if not hasFileIO() then return false, "no_fileio" end
	local ok, content = pcall(function() return readfile(CONFIG_FILENAME) end)
	if not ok then return false, content end
	local dec = safeDecode(content)
	if type(dec) == "table" then return true, dec end
	return false, "bad_json"
end
local function readBackupFile()
	if not hasFileIO() then return false, "no_fileio" end
	local ok, content = pcall(function() return readfile(BACKUP_FILENAME) end)
	if not ok then return false, content end
	local dec = safeDecode(content)
	if type(dec) == "table" then return true, dec end
	return false, "bad_json"
end

local function loadBestConfig()
	local attr = getAttr("FP_config")
	if type(attr) == "table" then return attr end
	if type(attr) == "string" then
		local dec = safeDecode(attr)
		if type(dec) == "table" then return dec end
	end
	local ok, dec = readConfigFile()
	if ok and type(dec) == "table" then
		setAttr("FP_config", dec)
		return dec
	end
	return DEFAULT
end

-- Setup initial config
if not player:GetAttribute("FP_config") then setAttr("FP_config", DEFAULT) end
local configNow = loadBestConfig()

-- Remove old GUI
local old = playerGui:FindFirstChild(GUI_NAME)
if old then old:Destroy() end

-- Create GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = GUI_NAME
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local main = Instance.new("Frame")
main.Name = "MainWindow"
local winW = (configNow.windowSize and configNow.windowSize[1]) or DEFAULT.windowSize[1]
local winH = (configNow.windowSize and configNow.windowSize[2]) or DEFAULT.windowSize[2]
main.Size = UDim2.new(0, winW, 0, winH)
main.Position = UDim2.new(0.5, -winW/2, 0.5, -winH/2)
main.AnchorPoint = Vector2.new(0.5, 0.5)
main.BackgroundColor3 = Color3.fromRGB(unpack(configNow.bgColor or DEFAULT.bgColor))
main.BorderSizePixel = 0
main.Active = true
main.Parent = screenGui
main.ClipsDescendants = true -- crucial: nothing will render outside main

local mainCorner = Instance.new("UICorner", main); mainCorner.CornerRadius = UDim.new(0, 12)

-- gradient top->bottom (darker for clarity)
local gradFrame = Instance.new("Frame", main)
gradFrame.Size = UDim2.new(1,0,1,0)
gradFrame.BackgroundTransparency = 1
local grad = Instance.new("UIGradient", gradFrame)
grad.Color = ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(32,32,34)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(50,30,36))
}
grad.Rotation = 90
grad.Transparency = NumberSequence.new(0.05)

-- Top bar
local topBar = Instance.new("Frame", main)
topBar.Name = "TopBar"
topBar.Size = UDim2.new(1,0,0,44)
topBar.Position = UDim2.new(0,0,0,0)
topBar.BackgroundColor3 = Color3.fromRGB(unpack(configNow.topBarColor or DEFAULT.topBarColor))
topBar.BorderSizePixel = 0
local topCorner = Instance.new("UICorner", topBar); topCorner.CornerRadius = UDim.new(0, 10)

local titleLabel = Instance.new("TextLabel", topBar)
titleLabel.Name = "Title"
titleLabel.Text = configNow.title_text or DEFAULT.title_text
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = configNow.fontSize or DEFAULT.fontSize
titleLabel.TextColor3 = Color3.fromRGB(unpack(configNow.textColor or DEFAULT.textColor))
titleLabel.BackgroundTransparency = 1
titleLabel.Position = UDim2.new(0, 12, 0, 8)
titleLabel.Size = UDim2.new(0.6, 0, 1, -12)
titleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Controls: minimize / close
local controls = Instance.new("Frame", topBar); controls.Size = UDim2.new(0, 96, 1, 0); controls.Position = UDim2.new(1, -100, 0, 0); controls.BackgroundTransparency = 1
local minBtn = Instance.new("TextButton", controls); minBtn.Size = UDim2.new(0,44,1,0); minBtn.Position = UDim2.new(0,0,0,0); minBtn.Text = "â€”"; minBtn.Font = Enum.Font.Gotham; minBtn.TextSize = 18; minBtn.BackgroundTransparency = 1; minBtn.TextColor3 = Color3.fromRGB(220,220,220)
local closeBtn = Instance.new("TextButton", controls); closeBtn.Size = UDim2.new(0,44,1,0); closeBtn.Position = UDim2.new(0,52,0,0); closeBtn.Text = "âœ•"; closeBtn.Font = Enum.Font.Gotham; closeBtn.TextSize = 16; closeBtn.BackgroundTransparency = 1; closeBtn.TextColor3 = Color3.fromRGB(220,220,220)

-- Tab strip (inside main)
local tabStrip = Instance.new("Frame", main)
tabStrip.Size = UDim2.new(1, -24, 0, 52)
tabStrip.Position = UDim2.new(0, 12, 0, 56)
tabStrip.BackgroundTransparency = 1

local function makeTab(text, left)
	local btn = Instance.new("TextButton", tabStrip)
	btn.Size = UDim2.new(0.5, -14, 1, -12)
	btn.Position = left and UDim2.new(0,6,0,6) or UDim2.new(0.5,8,0,6)
	btn.Text = text
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 14
	btn.TextColor3 = Color3.fromRGB(245,245,245)
	btn.BackgroundColor3 = Color3.fromRGB(58,58,58)
	btn.AutoButtonColor = false
	local c = Instance.new("UICorner", btn); c.CornerRadius = UDim.new(0, 8)
	return btn
end

local leftTabBtn = makeTab(configNow.tab_left or DEFAULT.tab_left, true)
local rightTabBtn = makeTab(configNow.tab_right or DEFAULT.tab_right, false)

-- Content container (inside main)
local content = Instance.new("Frame", main)
content.Name = "Content"
content.Size = UDim2.new(1, -24, 1, -128)
content.Position = UDim2.new(0, 12, 0, 118)
content.BackgroundTransparency = 1
content.ClipsDescendants = true

-- Pages (foxies + settings) - we'll animate their Position to slide/fade and ensure only one visible
local foxiesPage = Instance.new("Frame", content)
foxiesPage.Name = "FoxiesPage"
foxiesPage.Size = UDim2.new(1,0,1,0)
foxiesPage.Position = UDim2.new(0,0,0,0)
foxiesPage.BackgroundTransparency = 1
foxiesPage.ClipsDescendants = true

local settingsPage = Instance.new("Frame", content)
settingsPage.Name = "SettingsPage"
settingsPage.Size = UDim2.new(1,0,1,0)
settingsPage.Position = UDim2.new(1,0,0,0) -- off-canvas
settingsPage.BackgroundTransparency = 1
settingsPage.ClipsDescendants = true

-- Foxies page layout (left & right columns)
local leftCol = Instance.new("Frame", foxiesPage); leftCol.Size = UDim2.new(0.64, -8, 1, 0); leftCol.Position = UDim2.new(0,0,0,0); leftCol.BackgroundTransparency = 1; leftCol.ClipsDescendants = true
local rightCol = Instance.new("Frame", foxiesPage); rightCol.Size = UDim2.new(0.36, 8, 1, 0); rightCol.Position = UDim2.new(0.64, 8, 0, 0); rightCol.BackgroundTransparency = 1; rightCol.ClipsDescendants = true

-- helper: labeled multiline textbox
local function labeledTextBox(parent, labelText, y, initial)
	local lbl = Instance.new("TextLabel", parent)
	lbl.Size = UDim2.new(1,0,0,18); lbl.Position = UDim2.new(0,0,0,y)
	lbl.BackgroundTransparency = 1; lbl.Font = Enum.Font.Gotham; lbl.Text = labelText; lbl.TextSize = 14; lbl.TextColor3 = Color3.fromRGB(240,240,240); lbl.TextXAlignment = Enum.TextXAlignment.Left
	local box = Instance.new("TextBox", parent)
	box.Size = UDim2.new(1,0,0,110); box.Position = UDim2.new(0,0,0,y+24)
	box.MultiLine = true; box.ClearTextOnFocus = false; box.TextWrapped = true; box.Font = Enum.Font.SourceSans; box.TextSize = 14
	box.TextColor3 = Color3.fromRGB(230,230,230); box.BackgroundColor3 = Color3.fromRGB(20,20,20)
	box.Text = initial or "-- paste your Lua code here\n"
	local corner = Instance.new("UICorner", box); corner.CornerRadius = UDim.new(0,8)
	return box
end

local enableBox = labeledTextBox(leftCol, "Enable Script:", 6, configNow.enableScript or DEFAULT.enableScript)
local disableBox = labeledTextBox(leftCol, "Disable Script:", 140, configNow.disableScript or DEFAULT.disableScript)
local funnyBox = labeledTextBox(leftCol, "Funny Time Script:", 274, configNow.funnyScript or DEFAULT.funnyScript)

-- Right column: info and buttons
local topInfo = Instance.new("TextLabel", rightCol)
topInfo.Size = UDim2.new(1,-12,0,84); topInfo.Position = UDim2.new(0,6,0,6)
topInfo.BackgroundTransparency = 1; topInfo.Font = Enum.Font.Gotham; topInfo.TextSize = 13
topInfo.TextColor3 = Color3.fromRGB(240,240,240); topInfo.TextWrapped = true
topInfo.Text = "Paste your scripts on the left. Click buttons to execute. Config saves in real-time. Scripts run client-side."

local foxEmoji = "ðŸ¦Š "
local function fancyButton(parent, labelText, y, color)
	local frame = Instance.new("Frame", parent)
	frame.Size = UDim2.new(1,-12,0,46); frame.Position = UDim2.new(0,6,0,y); frame.BackgroundTransparency = 1
	local btn = Instance.new("TextButton", frame)
	btn.Size = UDim2.new(1,-52,1,0); btn.Position = UDim2.new(0,44,0,0)
	btn.BackgroundColor3 = color; btn.AutoButtonColor = false; btn.Font = Enum.Font.GothamBold; btn.Text = foxEmoji .. labelText; btn.TextSize = 16; btn.TextColor3 = Color3.fromRGB(255,255,255)
	local corner = Instance.new("UICorner", btn); corner.CornerRadius = UDim.new(0,10)
	local stroke = Instance.new("UIStroke", btn); stroke.Transparency = 0.75; stroke.Thickness = 1
	-- badge
	local badge = Instance.new("TextLabel", frame)
	badge.Size = UDim2.new(0,36,0,36); badge.Position = UDim2.new(0,6,0,5); badge.BackgroundTransparency = 1
	badge.Font = Enum.Font.GothamBold; badge.Text = "ðŸ¦Š"; badge.TextSize = 18; badge.TextColor3 = Color3.fromRGB(255,150,100)
	-- hover tweens
	local hover = TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
	btn.MouseEnter:Connect(function() TweenService:Create(btn, hover, {Size = UDim2.new(1,-42,1,6)}):Play() end)
	btn.MouseLeave:Connect(function() TweenService:Create(btn, hover, {Size = UDim2.new(1,-52,1,0)}):Play() end)
	btn.MouseButton1Down:Connect(function() TweenService:Create(btn, TweenInfo.new(0.06), {Position = btn.Position + UDim2.new(0,0,0,2)}):Play() end)
	btn.MouseButton1Up:Connect(function() TweenService:Create(btn, TweenInfo.new(0.06), {Position = btn.Position - UDim2.new(0,0,0,2)}):Play() end)
	return btn
end

local enableBtn = fancyButton(rightCol, (configNow.enable_label or "Enable"), 96, Color3.fromRGB(unpack(configNow.buttonColor or DEFAULT.buttonColor)))
local disableBtn = fancyButton(rightCol, (configNow.disable_label or "Disable"), 162, Color3.fromRGB(unpack(configNow.accentColor or DEFAULT.accentColor)))
local funnyBtn = fancyButton(rightCol, (configNow.funny_label or "Funny Time"), 228, Color3.fromRGB(unpack(configNow.buttonColor or DEFAULT.buttonColor)))

-- Execution helper
local function executeScriptChunk(scriptText)
	if type(scriptText) ~= "string" or scriptText:match("^%s*$") then
		return false, "empty"
	end
	if type(loadstring) == "function" then
		local ok, res = pcall(function() local fn = loadstring(scriptText); if type(fn) == "function" then fn() end end)
		return ok, res
	elseif type(load) == "function" then
		local ok, res = pcall(function() local fn = load(scriptText); if type(fn) == "function" then fn() end end)
		return ok, res
	else
		return false, "execution_unavailable"
	end
end

-- Toasts
local function showToast(text, time)
	if not (configNow.show_toasts == nil or configNow.show_toasts) then return end
	time = time or 1.8
	local frame = Instance.new("Frame", main)
	frame.Size = UDim2.new(0.6, 0, 0, 44)
	frame.Position = UDim2.new(0.5, 0, 0.92, 0)
	frame.AnchorPoint = Vector2.new(0.5, 1)
	frame.BackgroundColor3 = Color3.fromRGB(22,22,22)
	frame.BackgroundTransparency = 1
	frame.BorderSizePixel = 0
	local uic = Instance.new("UICorner", frame); uic.CornerRadius = UDim.new(0,8)
	local lbl = Instance.new("TextLabel", frame)
	lbl.Size = UDim2.new(1,-16,1,0); lbl.Position = UDim2.new(0,8,0,0); lbl.BackgroundTransparency = 1
	lbl.Font = Enum.Font.Gotham; lbl.TextSize = 15; lbl.TextColor3 = Color3.fromRGB(245,245,245)
	lbl.Text = text; lbl.TextXAlignment = Enum.TextXAlignment.Center; lbl.TextYAlignment = Enum.TextYAlignment.Center
	local inT = TweenService:Create(frame, TweenInfo.new(0.16, Enum.EasingStyle.Quad), {BackgroundTransparency = 0})
	inT:Play()
	task.delay(time, function()
		local outT = TweenService:Create(frame, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {BackgroundTransparency = 1})
		outT:Play()
		Debris:AddItem(frame, 0.26)
	end)
end

-- Real-time saving
local function persistConfig()
	-- build a fresh cfg from the currently saved attribute (so we don't lose other keys)
	local cfg = getAttr("FP_config") or {}
	if type(cfg) ~= "table" then cfg = {} end

	-- update cfg from current UI/visual state (these are the canonical sources)
	cfg.enableScript = enableBox.Text
	cfg.disableScript = disableBox.Text
	cfg.funnyScript = funnyBox.Text
	cfg.windowSize = { main.Size.X.Offset, main.Size.Y.Offset }
	cfg.buttonColor = { math.floor(enableBtn.BackgroundColor3.R*255+0.5), math.floor(enableBtn.BackgroundColor3.G*255+0.5), math.floor(enableBtn.BackgroundColor3.B*255+0.5) }
	cfg.accentColor = { math.floor(disableBtn.BackgroundColor3.R*255+0.5), math.floor(disableBtn.BackgroundColor3.G*255+0.5), math.floor(disableBtn.BackgroundColor3.B*255+0.5) }
	cfg.textColor = { math.floor(titleLabel.TextColor3.R*255+0.5), math.floor(titleLabel.TextColor3.G*255+0.5), math.floor(titleLabel.TextColor3.B*255+0.5) }
	cfg.topBarColor = { math.floor(topBar.BackgroundColor3.R*255+0.5), math.floor(topBar.BackgroundColor3.G*255+0.5), math.floor(topBar.BackgroundColor3.B*255+0.5) }
	cfg.bgColor = { math.floor(main.BackgroundColor3.R*255+0.5), math.floor(main.BackgroundColor3.G*255+0.5), math.floor(main.BackgroundColor3.B*255+0.5) }
	cfg.title_text = titleLabel.Text
	cfg.tab_left = leftTabBtn.Text
	cfg.tab_right = rightTabBtn.Text

	-- preserve values that are stored in configNow if not directly changed here
	cfg.show_toasts = (cfg.show_toasts ~= nil) and cfg.show_toasts or configNow.show_toasts
	cfg.hearts_per_interval = (cfg.hearts_per_interval ~= nil) and cfg.hearts_per_interval or configNow.hearts_per_interval
	cfg.heart_interval = (cfg.heart_interval ~= nil) and cfg.heart_interval or configNow.heart_interval
	cfg.saveMode = configNow.saveMode or DEFAULT.saveMode

	-- persist to attribute and optionally to file
	setAttr("FP_config", cfg)
	-- keep in-memory copy in sync
	configNow = cfg

	if cfg.saveMode == "file" or cfg.saveMode == "file_or_memory" then
		pcall(function() writeConfigFile(cfg) end)
	end
end

-- Throttled saves for text changes
local throttles = {}
local function throttleSave(key, delay)
	if throttles[key] then return end
	throttles[key] = true
	task.delay(delay or 0.6, function() throttles[key] = nil; persistConfig() end)
end

enableBox.FocusLost:Connect(function() persistConfig() end)
disableBox.FocusLost:Connect(function() persistConfig() end)
funnyBox.FocusLost:Connect(function() persistConfig() end)
enableBox:GetPropertyChangedSignal("Text"):Connect(function() throttleSave("enable") end)
disableBox:GetPropertyChangedSignal("Text"):Connect(function() throttleSave("disable") end)
funnyBox:GetPropertyChangedSignal("Text"):Connect(function() throttleSave("funny") end)

-- Buttons behavior
enableBtn.MouseButton1Click:Connect(function()
	local ok, err = executeScriptChunk(enableBox.Text)
	if ok then showToast("ðŸ¦Š Enabled!") else warnf("Enable failed:", err); showToast("Enable failed") end
	persistConfig()
end)
disableBtn.MouseButton1Click:Connect(function()
	local ok, err = executeScriptChunk(disableBox.Text)
	if ok then showToast("ðŸ¦Š Disabled!") else warnf("Disable failed:", err); showToast("Disable failed") end
	persistConfig()
end)
funnyBtn.MouseButton1Click:Connect(function()
	local ok, err = executeScriptChunk(funnyBox.Text)
	if ok then showToast("ðŸ¦Š Funny Time!") else warnf("Funny failed:", err); showToast("Funny failed") end
	persistConfig()
end)

-- Settings page widgets (inside settingsPage)
local sY = 8
local function settingRow(parent, label)
	local lbl = Instance.new("TextLabel", parent)
	lbl.Size = UDim2.new(0.5, -8, 0, 20); lbl.Position = UDim2.new(0,8,0,sY); lbl.BackgroundTransparency = 1; lbl.Font = Enum.Font.Gotham; lbl.TextSize = 14; lbl.TextColor3 = Color3.fromRGB(240,240,240); lbl.Text = label; lbl.TextXAlignment = Enum.TextXAlignment.Left
	local box = Instance.new("TextBox", parent)
	box.Size = UDim2.new(0.5, -8, 0, 22); box.Position = UDim2.new(0.5, 8, 0, sY); box.BackgroundColor3 = Color3.fromRGB(22,22,22); box.TextColor3 = Color3.fromRGB(230,230,230); box.Font = Enum.Font.SourceSans; box.TextSize = 14; box.ClearTextOnFocus = false
	sY = sY + 34
	return box
end

local btnColorInput = settingRow(settingsPage, "Button Color (r,g,b):"); btnColorInput.PlaceholderText = table.concat(configNow.buttonColor or DEFAULT.buttonColor, ",")
local accentColorInput = settingRow(settingsPage, "Accent Color (r,g,b):"); accentColorInput.PlaceholderText = table.concat(configNow.accentColor or DEFAULT.accentColor, ",")
local textColorInput = settingRow(settingsPage, "Text Color (r,g,b):"); textColorInput.PlaceholderText = table.concat(configNow.textColor or DEFAULT.textColor, ",")
local fontSizeInput = settingRow(settingsPage, "Font Size:"); fontSizeInput.PlaceholderText = tostring(configNow.fontSize or DEFAULT.fontSize)
local transInput = settingRow(settingsPage, "Window Transparency (0-0.9):"); transInput.PlaceholderText = tostring(configNow.transparency or DEFAULT.transparency)
local titleInput = settingRow(settingsPage, "Window Title:"); titleInput.PlaceholderText = tostring(configNow.title_text or DEFAULT.title_text)
local leftTabInput = settingRow(settingsPage, "Left Tab Name:"); leftTabInput.PlaceholderText = tostring(configNow.tab_left or DEFAULT.tab_left)
local rightTabInput = settingRow(settingsPage, "Right Tab Name:"); rightTabInput.PlaceholderText = tostring(configNow.tab_right or DEFAULT.tab_right)

-- hearts controls
local heartLbl = Instance.new("TextLabel", settingsPage); heartLbl.Size = UDim2.new(0.5,-8,0,22); heartLbl.Position = UDim2.new(0,8,0,sY); heartLbl.BackgroundTransparency = 1; heartLbl.Font = Enum.Font.Gotham; heartLbl.TextSize = 14; heartLbl.TextColor3 = Color3.fromRGB(240,240,240); heartLbl.Text = "Hearts per interval:"
local heartFrame = Instance.new("Frame", settingsPage); heartFrame.Size = UDim2.new(0.5,-8,0,26); heartFrame.Position = UDim2.new(0.5,8,0,sY); heartFrame.BackgroundTransparency = 1
local heartDec = Instance.new("TextButton", heartFrame); heartDec.Size = UDim2.new(0,28,1,0); heartDec.Position = UDim2.new(0,0,0,0); heartDec.Text = "âˆ’"; heartDec.Font = Enum.Font.Gotham; heartDec.BackgroundColor3 = Color3.fromRGB(70,70,70)
local heartVal = Instance.new("TextLabel", heartFrame); heartVal.Size = UDim2.new(0, -56,1,0); heartVal.Position = UDim2.new(0,34,0,0); heartVal.BackgroundTransparency = 1; heartVal.Font = Enum.Font.Gotham; heartVal.TextSize = 14; heartVal.TextColor3 = Color3.fromRGB(240,240,240); heartVal.TextXAlignment = Enum.TextXAlignment.Center
local heartInc = Instance.new("TextButton", heartFrame); heartInc.Size = UDim2.new(0,28,1,0); heartInc.Position = UDim2.new(1,-28,0,0); heartInc.AnchorPoint = Vector2.new(1,0); heartInc.Text = "+"; heartInc.Font = Enum.Font.Gotham; heartInc.BackgroundColor3 = Color3.fromRGB(70,70,70)
sY = sY + 36

local toastLbl = Instance.new("TextLabel", settingsPage); toastLbl.Size = UDim2.new(0.5,-8,0,22); toastLbl.Position = UDim2.new(0,8,0,sY); toastLbl.BackgroundTransparency = 1; toastLbl.Font = Enum.Font.Gotham; toastLbl.TextSize = 14; toastLbl.TextColor3 = Color3.fromRGB(240,240,240); toastLbl.Text = "Show toasts:"
local toastToggle = Instance.new("TextButton", settingsPage); toastToggle.Size = UDim2.new(0.5,-8,0,26); toastToggle.Position = UDim2.new(0.5,8,0,sY-2); toastToggle.BackgroundColor3 = Color3.fromRGB(80,80,80); toastToggle.Font = Enum.Font.Gotham; toastToggle.Text = (configNow.show_toasts and "On" or "Off")
sY = sY + 36

-- Export/import controls
local exportBox = Instance.new("TextBox", settingsPage); exportBox.Size = UDim2.new(1,-16,0,64); exportBox.Position = UDim2.new(0,8,0,sY); exportBox.MultiLine = true; exportBox.Font = Enum.Font.SourceSans; exportBox.TextSize = 12; exportBox.BackgroundColor3 = Color3.fromRGB(22,22,22); exportBox.Text = "-- export will appear here --"
local ec = Instance.new("UICorner", exportBox); ec.CornerRadius = UDim.new(0,8)
sY = sY + 72
local importBox = Instance.new("TextBox", settingsPage); importBox.Size = UDim2.new(1,-16,0,64); importBox.Position = UDim2.new(0,8,0,sY); importBox.MultiLine = true; importBox.Font = Enum.Font.SourceSans; importBox.TextSize = 12; importBox.BackgroundColor3 = Color3.fromRGB(22,22,22); importBox.Text = "-- paste JSON here to import --"
local ic = Instance.new("UICorner", importBox); ic.CornerRadius = UDim.new(0,8)
sY = sY + 72

-- Action buttons
local applyBtn = Instance.new("TextButton", settingsPage); applyBtn.Size = UDim2.new(0,140,0,34); applyBtn.Position = UDim2.new(0.04,0,0,sY); applyBtn.Text = "Apply Settings"; applyBtn.Font = Enum.Font.Gotham; applyBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
local saveBtn = applyBtn:Clone(); saveBtn.Parent = settingsPage; saveBtn.Position = UDim2.new(0.54,0,0,sY); saveBtn.Text = "Save Config"; saveBtn.BackgroundColor3 = Color3.fromRGB(70,130,180)
sY = sY + 46
local loadBtn = applyBtn:Clone(); loadBtn.Parent = settingsPage; loadBtn.Position = UDim2.new(0.04,0,0,sY); loadBtn.Text = "Load Config"; loadBtn.BackgroundColor3 = Color3.fromRGB(70,160,90)
local exportBtn = loadBtn:Clone(); exportBtn.Parent = settingsPage; exportBtn.Position = UDim2.new(0.54,0,0,sY); exportBtn.Text = "Export JSON"; exportBtn.BackgroundColor3 = Color3.fromRGB(110,100,100)
sY = sY + 46

-- Backup / Restore buttons (new)
local backupBtn = Instance.new("TextButton", settingsPage); backupBtn.Size = UDim2.new(0,140,0,34); backupBtn.Position = UDim2.new(0.04,0,0,sY); backupBtn.Text = "Make Backup"; backupBtn.Font = Enum.Font.Gotham; backupBtn.BackgroundColor3 = Color3.fromRGB(200,150,50)
local restoreBtn = backupBtn:Clone(); restoreBtn.Parent = settingsPage; restoreBtn.Position = UDim2.new(0.54,0,0,sY); restoreBtn.Text = "Restore Backup"; restoreBtn.BackgroundColor3 = Color3.fromRGB(120,100,200)
sY = sY + 46

-- heart controls behavior
local heartCount = tonumber(configNow.hearts_per_interval) or DEFAULT.hearts_per_interval
local heartInterval = tonumber(configNow.heart_interval) or DEFAULT.heart_interval
heartVal.Text = tostring(heartCount)
heartInc.MouseButton1Click:Connect(function() heartCount = clamp(heartCount + 1, 0, 20); heartVal.Text = tostring(heartCount); configNow.hearts_per_interval = heartCount; persistConfig() end)
heartDec.MouseButton1Click:Connect(function() heartCount = clamp(heartCount - 1, 0, 20); heartVal.Text = tostring(heartCount); configNow.hearts_per_interval = heartCount; persistConfig() end)
toastToggle.MouseButton1Click:Connect(function() configNow.show_toasts = not configNow.show_toasts; toastToggle.Text = configNow.show_toasts and "On" or "Off"; persistConfig() end)

-- Apply settings behavior
applyBtn.MouseButton1Click:Connect(function()
	local cfg = loadBestConfig()
	local function parseTriplet(s, old)
		if type(s) ~= "string" or s == "" then return old end
		local r,g,b = s:match("(%d+)%s*,%s*(%d+)%s*,%s*(%d+)")
		if not r then r,g,b = s:match("(%d+)%s+(%d+)%s+(%d+)") end
		if r then return {tonumber(r), tonumber(g), tonumber(b)} end
		return old
	end
	cfg.buttonColor = parseTriplet(btnColorInput.Text, cfg.buttonColor or DEFAULT.buttonColor)
	cfg.accentColor = parseTriplet(accentColorInput.Text, cfg.accentColor or DEFAULT.accentColor)
	cfg.textColor = parseTriplet(textColorInput.Text, cfg.textColor or DEFAULT.textColor)
	if fontSizeInput.Text ~= "" then cfg.fontSize = tonumber(fontSizeInput.Text) or cfg.fontSize end
	if transInput.Text ~= "" then cfg.transparency = clamp(tonumber(transInput.Text) or cfg.transparency, 0, 0.9) end
	if titleInput.Text ~= "" then cfg.title_text = titleInput.Text; titleLabel.Text = cfg.title_text end
	if leftTabInput.Text ~= "" then cfg.tab_left = leftTabInput.Text; leftTabBtn.Text = cfg.tab_left end
	if rightTabInput.Text ~= "" then cfg.tab_right = rightTabInput.Text; rightTabBtn.Text = cfg.tab_right end

	-- NOTE: We intentionally do not change cfg.bgColor/topBarColor unless user provides UI for them,
	-- to avoid unexpectedly changing background if not edited.
	main.BackgroundColor3 = Color3.fromRGB(unpack(cfg.bgColor or DEFAULT.bgColor))
	topBar.BackgroundColor3 = Color3.fromRGB(unpack(cfg.topBarColor or DEFAULT.topBarColor))
	enableBtn.BackgroundColor3 = Color3.fromRGB(unpack(cfg.buttonColor or DEFAULT.buttonColor))
	disableBtn.BackgroundColor3 = Color3.fromRGB(unpack(cfg.accentColor or DEFAULT.accentColor))
	titleLabel.TextColor3 = Color3.fromRGB(unpack(cfg.textColor or DEFAULT.textColor))
	titleLabel.TextSize = cfg.fontSize or titleLabel.TextSize

	-- ensure tabs immediately reflect the chosen colors and persist
	leftTabBtn.BackgroundColor3 = Color3.fromRGB(unpack(cfg.buttonColor or DEFAULT.buttonColor))
	rightTabBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)

	setAttr("FP_config", cfg)
	-- update in-memory configNow and persist so file + attributes are synced
	configNow = cfg
	persistConfig()
	showToast("Settings applied")
end)

-- Save/Export/Load behavior
saveBtn.MouseButton1Click:Connect(function()
	-- persist current UI to configNow/attribute first
	persistConfig()
	-- write to file if fileIO available and saveMode allows
	local cfg = configNow or loadBestConfig()
	local ok, err = writeConfigFile(cfg)
	if ok then
		showToast("Config saved to file")
	else
		-- fallback: if no fileIO, still saved to attribute/memory
		if err == "no_fileio" then
			showToast("Saved in memory (no file I/O)")
		else
			showToast("Save failed")
			warnf("Save failed:", err)
		end
	end
end)

exportBtn.MouseButton1Click:Connect(function()
	local cfg = loadBestConfig()
	exportBox.Text = safeEncode(cfg) or "-- export failed --"
	showToast("Export ready")
end)

loadBtn.MouseButton1Click:Connect(function()
	local ok, fileCfg = readConfigFile()
	if ok then
		configNow = fileCfg
		enableBox.Text = fileCfg.enableScript or enableBox.Text
		disableBox.Text = fileCfg.disableScript or disableBox.Text
		funnyBox.Text = fileCfg.funnyScript or funnyBox.Text
		enableBtn.BackgroundColor3 = Color3.fromRGB(unpack(fileCfg.buttonColor or DEFAULT.buttonColor))
		disableBtn.BackgroundColor3 = Color3.fromRGB(unpack(fileCfg.accentColor or DEFAULT.accentColor))
		titleLabel.Text = fileCfg.title_text or titleLabel.Text
		leftTabBtn.Text = fileCfg.tab_left or leftTabBtn.Text
		rightTabBtn.Text = fileCfg.tab_right or rightTabBtn.Text
		-- ensure visual tab color is consistent immediately
		leftTabBtn.BackgroundColor3 = Color3.fromRGB(unpack(fileCfg.buttonColor or DEFAULT.buttonColor))
		rightTabBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
		setAttr("FP_config", fileCfg)
		persistConfig()
		showToast("Config loaded (file)")
		return
	end
	local attr = getAttr("FP_config")
	if type(attr) == "table" then
		configNow = attr
		enableBox.Text = attr.enableScript or enableBox.Text
		disableBox.Text = attr.disableScript or disableBox.Text
		funnyBox.Text = attr.funnyScript or funnyBox.Text
		enableBtn.BackgroundColor3 = Color3.fromRGB(unpack(attr.buttonColor or DEFAULT.buttonColor))
		disableBtn.BackgroundColor3 = Color3.fromRGB(unpack(attr.accentColor or DEFAULT.accentColor))
		titleLabel.Text = attr.title_text or titleLabel.Text
		leftTabBtn.Text = attr.tab_left or leftTabBtn.Text
		rightTabBtn.Text = attr.tab_right or rightTabBtn.Text
		-- ensure immediate visual sync
		leftTabBtn.BackgroundColor3 = Color3.fromRGB(unpack(attr.buttonColor or DEFAULT.buttonColor))
		rightTabBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
		showToast("Config loaded (memory)")
	else
		showToast("No config found")
	end
end)

local importBtn = Instance.new("TextButton", settingsPage)
importBtn.Size = UDim2.new(0,140,0,34); importBtn.Position = UDim2.new(0.04,0,0,sY); importBtn.Text = "Import JSON"; importBtn.Font = Enum.Font.Gotham; importBtn.BackgroundColor3 = Color3.fromRGB(120,70,160)
local importCorner = Instance.new("UICorner", importBtn); importCorner.CornerRadius = UDim.new(0,8)
importBtn.MouseButton1Click:Connect(function()
	local txt = importBox.Text
	if not txt or txt:match("^%s*$") then exportBox.Text = "-- No JSON provided --"; showToast("No JSON"); return end
	local dec = safeDecode(txt)
	if not dec or type(dec) ~= "table" then exportBox.Text = "-- Invalid JSON --"; showToast("Invalid JSON"); return end
	configNow = dec
	enableBox.Text = dec.enableScript or enableBox.Text
	disableBox.Text = dec.disableScript or disableBox.Text
	funnyBox.Text = dec.funnyScript or funnyBox.Text
	enableBtn.BackgroundColor3 = Color3.fromRGB(unpack(dec.buttonColor or DEFAULT.buttonColor))
	disableBtn.BackgroundColor3 = Color3.fromRGB(unpack(dec.accentColor or DEFAULT.accentColor))
	titleLabel.Text = dec.title_text or titleLabel.Text
	leftTabBtn.Text = dec.tab_left or leftTabBtn.Text
	rightTabBtn.Text = dec.tab_right or rightTabBtn.Text
	-- immediate visual sync
	leftTabBtn.BackgroundColor3 = Color3.fromRGB(unpack(dec.buttonColor or DEFAULT.buttonColor))
	rightTabBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
	setAttr("FP_config", dec)
	persistConfig() -- ensure file + attribute written if saveMode allows
	showToast("Imported and applied")
end)

-- Backup functionality
backupBtn.MouseButton1Click:Connect(function()
	-- ensure we persist latest UI into configNow
	persistConfig()
	local ok, err = writeBackupFile(configNow)
	if ok then
		showToast("Backup created")
	else
		if err == "no_fileio" then
			showToast("Backup skipped (no file I/O)")
		else
			showToast("Backup failed")
			warnf("Backup failed:", err)
		end
	end
end)

restoreBtn.MouseButton1Click:Connect(function()
	-- try to restore from backup file
	local ok, dec = readBackupFile()
	if ok and type(dec) == "table" then
		configNow = dec
		-- apply to UI
		enableBox.Text = dec.enableScript or enableBox.Text
		disableBox.Text = dec.disableScript or disableBox.Text
		funnyBox.Text = dec.funnyScript or funnyBox.Text
		enableBtn.BackgroundColor3 = Color3.fromRGB(unpack(dec.buttonColor or DEFAULT.buttonColor))
		disableBtn.BackgroundColor3 = Color3.fromRGB(unpack(dec.accentColor or DEFAULT.accentColor))
		titleLabel.Text = dec.title_text or titleLabel.Text
		leftTabBtn.Text = dec.tab_left or leftTabBtn.Text
		rightTabBtn.Text = dec.tab_right or rightTabBtn.Text
		-- sync visuals
		leftTabBtn.BackgroundColor3 = Color3.fromRGB(unpack(dec.buttonColor or DEFAULT.buttonColor))
		rightTabBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
		setAttr("FP_config", dec)
		persistConfig()
		showToast("Backup restored")
		return
	end
	if dec == "no_fileio" then
		showToast("No file I/O to restore from")
	else
		showToast("No backup found")
	end
end)

-- Tab switching (smooth fade & slide)
local tabTween = TweenInfo.new(0.22, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local function showFoxies()
	leftTabBtn.BackgroundColor3 = Color3.fromRGB(unpack(configNow.buttonColor or DEFAULT.buttonColor))
	rightTabBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
	TweenService:Create(foxiesPage, tabTween, {Position = UDim2.new(0,0,0,0)}):Play()
	TweenService:Create(settingsPage, tabTween, {Position = UDim2.new(1,0,0,0)}):Play()
end
local function showSettings()
	rightTabBtn.BackgroundColor3 = Color3.fromRGB(unpack(configNow.buttonColor or DEFAULT.buttonColor))
	leftTabBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
	TweenService:Create(foxiesPage, tabTween, {Position = UDim2.new(-1,0,0,0)}):Play()
	TweenService:Create(settingsPage, tabTween, {Position = UDim2.new(0,0,0,0)}):Play()
end

leftTabBtn.MouseButton1Click:Connect(showFoxies)
rightTabBtn.MouseButton1Click:Connect(showSettings)

-- Drag behavior (topBar)
do
	local dragging, dragStart, startPos, dragInput
	topBar.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true; dragStart = input.Position; startPos = main.Position
			input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
		end
	end)
	topBar.InputChanged:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end end)
	UserInputService.InputChanged:Connect(function(input)
		if dragging and input == dragInput then
			local delta = input.Position - dragStart
			main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end)
end

-- Resize handle
local resize = Instance.new("Frame", main); resize.Name = "Resize"; resize.Size = UDim2.new(0,16,0,16); resize.Position = UDim2.new(1,-22,1,-22); resize.BackgroundColor3 = Color3.fromRGB(80,80,80)
local resizeCorner = Instance.new("UICorner", resize); resizeCorner.CornerRadius = UDim.new(1,0); resize.Active = true
do
	local resizing, startPos, startSize
	resize.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			resizing = true; startPos = input.Position; startSize = Vector2.new(main.AbsoluteSize.X, main.AbsoluteSize.Y)
			input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then resizing = false; local cfg = getAttr("FP_config") or DEFAULT; cfg.windowSize = {main.Size.X.Offset, main.Size.Y.Offset}; setAttr("FP_config", cfg); persistConfig() end end)
		end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if resizing and input.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = input.Position - startPos
			local newW = clamp(startSize.X + delta.X, 480, 1400)
			local newH = clamp(startSize.Y + delta.Y, 320, 1000)
			main.Size = UDim2.new(0, newW, 0, newH)
		end
	end)
end

-- Minimize/close & reopen
local minimized = false; local prevSize, prevPos
minBtn.MouseButton1Click:Connect(function()
	if not minimized then
		prevSize = main.Size; prevPos = main.Position; minimized = true
		TweenService:Create(main, TweenInfo.new(0.18), {Size = UDim2.new(0, 360, 0, 48), Position = UDim2.new(0.5, -180, 0.5, -160)}):Play()
	else
		minimized = false
		TweenService:Create(main, TweenInfo.new(0.18), {Size = prevSize, Position = prevPos}):Play()
	end
end)
closeBtn.MouseButton1Click:Connect(function() main.Visible = false end)
UserInputService.InputBegan:Connect(function(input, gpe) if gpe then return end if input.KeyCode == Enum.KeyCode.RightShift then main.Visible = not main.Visible end end)

-- Floating hearts inside main (respect bounds)
local heartTask
local function spawnHeart()
	if not main.Parent or not main.Visible then return end
	local heart = Instance.new("TextLabel", main)
	heart.Text = "ðŸ’–"; heart.Font = Enum.Font.GothamBold; heart.TextSize = math.random(14,22)
	heart.TextColor3 = Color3.fromRGB(unpack(configNow.accentColor or DEFAULT.accentColor))
	heart.BackgroundTransparency = 1
	heart.Size = UDim2.new(0, 26, 0, 26)
	local absW = math.max(64, main.AbsoluteSize.X - 64)
	local x = math.random(32, absW)
	heart.Position = UDim2.new(0, x, 1, -34)
	local riseTime = (configNow.heart_interval or DEFAULT.heart_interval) + (math.random()*0.8 - 0.4)
	local target = UDim2.new(0, x + (math.random(-12,12)), 0, -30)
	local tw = TweenService:Create(heart, TweenInfo.new(riseTime, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {Position = target, TextTransparency = 1})
	tw:Play()
	Debris:AddItem(heart, riseTime + 0.2)
end

local function startHearts()
	if heartTask then return end
	heartTask = task.spawn(function()
		while main.Parent do
			if main.Visible then
				for i=1,(configNow.hearts_per_interval or DEFAULT.hearts_per_interval) do
					spawnHeart()
				end
			end
			task.wait(configNow.heart_interval or DEFAULT.heart_interval)
		end
	end)
end
startHearts()

-- initial restore of stored config
local stored = getAttr("FP_config")
if type(stored) == "table" then
	if stored.enableScript then enableBox.Text = stored.enableScript end
	if stored.disableScript then disableBox.Text = stored.disableScript end
	if stored.funnyScript then funnyBox.Text = stored.funnyScript end
	if stored.windowSize and stored.windowSize[1] and stored.windowSize[2] then
		local w = clamp(stored.windowSize[1], 480, 1400)
		local h = clamp(stored.windowSize[2], 320, 1000)
		main.Size = UDim2.new(0, w, 0, h)
	end
	if stored.title_text then titleLabel.Text = stored.title_text end
	if stored.tab_left then leftTabBtn.Text = stored.tab_left end
	if stored.tab_right then rightTabBtn.Text = stored.tab_right end
end

-- initial visuals
main.Position = main.Position + UDim2.new(0,0,0,18)
TweenService:Create(main, TweenInfo.new(0.22, Enum.EasingStyle.Quad), {Position = main.Position - UDim2.new(0,0,0,18)}):Play()
leftTabBtn.BackgroundColor3 = Color3.fromRGB(unpack(configNow.buttonColor or DEFAULT.buttonColor))
rightTabBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)

print("[FoxParty] Polished GUI loaded. Everything contained inside the main window.")
